class SolidresMediaManager extends HTMLElement{static get observedAttributes(){return["type","name","single","target-id","target-element-id"]}constructor(){super(),this.sources=[]}request(e){this.classList.add("loading");const t="SRMediaResourceData[0]="+JSON.stringify({type:this.type,name:this.name,multiple:this.multiple}),s=`${Joomla.getOptions("system.paths").baseFull}?option=com_solidres&${t}&id=${this.targetId}&format=json&${e.query}`,i=new XMLHttpRequest;i.onreadystatechange=()=>{if(4===i.readyState&&200===i.status){try{const{success:t,message:s,data:a}=JSON.parse(i.responseText);t?"function"==typeof e.success&&e.success.bind(this)(a):"function"==typeof e.error&&e.error.bind(this)(s)}catch(e){console.debug(e)}this.classList.remove("loading")}},i.open(e.method||"GET",s,!0);let a=null;if(e.isUpload||i.setRequestHeader("Content-Type","application/json"),"POST"===e.method&&e.data&&(a=e.isUpload?e.data:JSON.stringify(e.data)),"GET"!==e.method){const e=Joomla.getOptions("csrf.token","");e&&i.setRequestHeader("X-CSRF-Token",e)}i.send(a)}createMediaCard(e){const t=document.createElement("div");return t.className="sr-media-card",e.image&&(0===e.image.indexOf("data:image")?t.style.backgroundImage=`url(${e.image})`:(t.setAttribute("data-src",e.image),t.style.backgroundImage=`url(${Joomla.getOptions("system.paths").rootFull+e.thumb})`),e.file&&this.cardFileMaps.push({card:t,file:e.file})),t.innerHTML='<button class="sr-btn-remove-media" type="button"><i class="fa fa-trash"></i></button>',t.querySelector(".sr-btn-remove-media").addEventListener("click",()=>{if(this.targetId)this.request({query:"task=media.removeResource",method:"POST",data:{src:e.image},success:()=>{t.parentElement.removeChild(t);const s=this.sources.findIndex(t=>e.image===t.image);-1!==s&&this.sources.splice(s,1),this.multiple||(this.fileInput.value="",this.sources.length||(this.btnUpload.style.display="")),this.targetElement&&(this.multiple?this.targetElement.value=this.sources.map(e=>e.image.substring(e.image.lastIndexOf("/")+1)).join(","):this.targetElement.value=""),this.targetElement?.dispatchEvent(new Event("change"))},error:e=>Joomla?.renderMessages({warning:[e]})});else if(t.parentElement.removeChild(t),e.file){const t=this.cardFileMaps.findIndex(({file:t})=>t===e.file);-1!==t&&this.cardFileMaps.splice(t,1),this.multiple||(this.fileInput.value="",this.cardFileMaps.length||(this.btnUpload.style.display=""))}},!1),t}reOrderSources(e){this.request({query:"task=media.reOrderResources",method:"POST",data:{sources:e},success:e=>{if(this.sources=e,this.targetElement){const e=this.sources.map(e=>e.image.substring(e.image.lastIndexOf("/")+1));this.targetElement.value=e.join(",");try{const t=[],s=this.multiple?JSON.parse(this.targetElement.getAttribute("data-src")):[this.targetElement.getAttribute("data-src")];for(const i of e)t.push(s.find(e=>e.substring(e.lastIndexOf("/")+1)===i));this.targetElement.setAttribute("data-src",JSON.stringify(t))}catch{}}},error:e=>Joomla?.renderMessages({warning:[e]})})}connectedCallback(){this.cardFileMaps=[],this.multiple=this.hasAttribute("single")?0:1,this.name=this.getAttribute("name")||"",this.type=(this.getAttribute("type")||"PROPERTY").toUpperCase(),this.targetId=parseInt(this.getAttribute("target-id")||"0");const e=this.getAttribute("target-element-id");this.targetElement=e?this.ownerDocument.getElementById(e):null,["PROPERTY","ROOM_TYPE","EXPERIENCE","PRO_COUPON","EXP_COUPON","PRO_EXTRA","EXP_EXTRA","EXP_CATEGORY","EXP_PAYMENT"].includes(this.type)||(this.type="PROPERTY"),isNaN(this.targetId)&&(this.targetId=0);const t=document.createElement("div");if(t.className="sr-media-container",this.appendChild(t),this.btnUpload=document.createElement("button"),this.btnUpload.type="button",this.btnUpload.className="sr-btn-upload-media",this.btnUpload.innerHTML='<i class="fa fa-plus"></i>',this.fileInput=document.createElement("input"),this.fileInput.name=(this.name?this.name.replace(/\./g,"_")+"_":"")+"SRUploadedMedia[]",this.fileInput.type="file",this.fileInput.multiple=!!this.multiple,this.fileInput.accept="image/*",this.fileInput.style.display="none",this.fileInput.addEventListener("change",()=>{const{files:e}=this.fileInput;if(e&&e.length){if(this.targetId){const s=new FormData;for(const t of e)s.append(this.fileInput.name,t);this.request({isUpload:!0,query:"task=media.uploadResources",method:"POST",data:s,success:e=>{const{sources:s,messages:i}=e[0];if(s.length)if(this.multiple){for(const e of s)this.sources.push(e),t.appendChild(this.createMediaCard(e));this.targetElement&&(this.targetElement.value=this.sources.map(e=>e.image.substring(e.image.lastIndexOf("/")+1)).join(","))}else{this.btnUpload.style.display="none";const e=s[0];this.targetElement&&(this.targetElement.value=e.image.substring(e.image.lastIndexOf("/")+1)),this.sources=[e],t.innerHTML="",t.appendChild(this.createMediaCard(e))}else this.targetElement&&(this.targetElement.value="");this.targetElement?.dispatchEvent(new Event("change")),i.length&&Joomla?.renderMessages({warning:i})},error:e=>{Joomla?.renderMessages({warning:[e]})}})}else for(const s of e){const e=new FileReader;e.onload=e=>{const i=new Image;i.onload=()=>{const e=document.createElement("canvas"),a=e.getContext("2d");let n=i.width,r=i.height;n>120&&(r*=120/n,n=120),r>120&&(n*=120/r,r=120),e.width=n,e.height=r,a.drawImage(i,0,0,n,r),t.appendChild(this.createMediaCard({image:e.toDataURL(s.type),file:s}))},i.src=e.target.result},e.readAsDataURL(s)}this.multiple||(this.btnUpload.style.display="none")}else this.multiple||(this.btnUpload.style.display="");this.targetId&&(this.fileInput.value="")},!1),this.appendChild(this.fileInput),this.form=this.closest("form"),this.form&&!this.targetId){const e=this.ownerDocument.createElement("input");e.type="hidden",e.name="SRMediaResourceData[]",e.value=JSON.stringify({type:this.type,name:this.name,multiple:this.multiple}),this.appendChild(e),this.form.addEventListener("submit",()=>{const e=new DataTransfer;for(const{file:t}of this.cardFileMaps)e.items.add(t);this.fileInput.files=e.files,this.multiple&&this.targetElement?.value&&(this.targetElement.value=JSON.stringify(this.targetElement.value.split(",")))})}if(this.btnUpload.addEventListener("click",()=>this.fileInput.click(),!1),this.appendChild(this.btnUpload),this.targetElement){let e=this.targetElement.getAttribute("data-src");if(e){this.multiple?e=JSON.parse(e):this.btnUpload.style.display="none",Array.isArray(e)||(e=[e]);for(const s of e){const e={image:s,thumb:s};this.sources.push(e),t.appendChild(this.createMediaCard(e))}}}else this.targetId&&this.request({query:"task=media.loadResources",success(e){if(e.length)for(const s of e)this.sources.push(s),t.appendChild(this.createMediaCard(s))},error(e){this.innerHTML='<div class="alert alert-warning">'+e+"</div>"}})}}customElements.define("solidres-media-manager",SolidresMediaManager),window.addEventListener("load",function(){document.querySelectorAll("solidres-media-manager > .sr-media-container").forEach(e=>{e.parentElement.hasAttribute("single")||dragula([e],{copy:!1,direction:"horizontal",mirrorContainer:e,moves:(e,t,s)=>!s.classList.contains("sr-btn-remove-media")&&!s.closest(".sr-btn-remove-media")}).on("dragend",t=>{const{targetId:s,sources:i,cardFileMaps:a}=e.parentElement,n=[];s?(e.querySelectorAll(".sr-media-card").forEach(e=>{const t=i.find(({image:t})=>t===e.getAttribute("data-src"));t&&n.push(t.image.split("/").pop())}),e.parentElement.reOrderSources(n)):(e.querySelectorAll(".sr-media-card").forEach(e=>{const t=a.find(({card:t})=>t===e);t&&n.push(t)}),e.parentElement.cardFileMaps=n)})})});